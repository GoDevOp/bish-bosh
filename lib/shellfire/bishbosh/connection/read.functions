core_usesIn bishbosh/connection/read CONNACK CONNECT DISCONNECT invalid PINGREQ PINGRESP

bishbosh_connection_read_protocolError()
{
	local controlPacket="$1"
	local message="$2"
	core_message WARN "Connection:$bishbosh_connection_id:read:$controlPacket:$message"
	return $core_commandLine_exitCode_PROTOCOL
}

bishbosh_connection_read_protocolErrorIfRemainingLengthNot()
{
	local controlPacket="$1"
	local expectedLength=$2
	if [ $firstRemainingLengthByte -ne $expectedLength ]; then
		bishbosh_connection_read_protocolError "$controlPacket" "Remaining length '$firstRemainingLengthByte' should be $expectedLength"
	fi
}

bishbosh_connection_read_protocolErrorIfRemainingLengthNotZero()
{
	bishbosh_connection_read_protocolErrorIfRemainingLengthNot "$1" 0
}

bishbosh_connection_read_initialise()
{
	local isServer="$1"
	if core_variable_isTrue "$isServer"; then
		bishbosh_connection_read_CONNACK()
		{
			bishbosh_connection_read_invalid
		}
		bishbosh_connection_read_SUBACK()
		{
			bishbosh_connection_read_invalid
		}
		bishbosh_connection_read_UNSUBACK()
		{
			bishbosh_connection_read_invalid
		}
		bishbosh_connection_read_PINGRESP()
		{
			bishbosh_connection_read_invalid
		}
	else
		bishbosh_connection_read_CONNECT()
		{
			bishbosh_connection_read_invalid
		}
		bishbosh_connection_read_SUBSCRIBE()
		{
			bishbosh_connection_read_invalid
		}
		bishbosh_connection_read_UNSUBSCRIBE()
		{
			bishbosh_connection_read_invalid
		}
		bishbosh_connection_read_PINGREQ()
		{
			bishbosh_connection_read_invalid
		}
		bishbosh_connection_read_DISCONNECT()
		{
			bishbosh_connection_read_invalid
		}
	fi
}

bishbosh_connection_read_byte()
{
	IFS=' ' read -r $1
}

bishbosh_connection_read_bytes()
{
	IFS=' ' read -r $@
}

bishbosh_connection_read_next()
{
	set -x
	bishbosh_connection_read_byte controlPacketByte
	echo $controlPacketByte
	bishbosh_connection_read_byte firstRemainingLengthByte
	echo $firstRemainingLengthByte
	
	case $controlPacketByte in
		
		16)
			# Only valid for servers
			bishbosh_connection_read_CONNECT
		;;
		
		32)
			# Only valid for clients
			bishbosh_connection_read_CONNACK
		;;
		
		48)
			bishbosh_connection_read_PUBLISH_0
		;;
		
		49)
			bishbosh_connection_read_PUBLISH_1
		;;
		
		50)
			bishbosh_connection_read_PUBLISH_2
		;;
		
		51)
			bishbosh_connection_read_PUBLISH_3
		;;
		
		52)
			bishbosh_connection_read_PUBLISH_4
		;;
		
		53)
			bishbosh_connection_read_PUBLISH_5
		;;
		
		54)
			bishbosh_connection_read_PUBLISH_6
		;;
		
		55)
			bishbosh_connection_read_PUBLISH_7
		;;
		
		56)
			bishbosh_connection_read_PUBLISH_8
		;;
		
		57)
			bishbosh_connection_read_PUBLISH_9
		;;
		
		58)
			bishbosh_connection_read_PUBLISH_10
		;;
		
		59)
			bishbosh_connection_read_PUBLISH_11
		;;
		
		60)
			bishbosh_connection_read_PUBLISH_12
		;;
		
		61)
			bishbosh_connection_read_PUBLISH_13
		;;
		
		62)
			bishbosh_connection_read_PUBLISH_14
		;;
		
		63)
			bishbosh_connection_read_PUBLISH_15
		;;
		
		64)
			bishbosh_connection_read_PUBACK
		;;
		
		80)
			bishbosh_connection_read_PUBREC
		;;
		
		98)
			bishbosh_connection_read_PUBREL
		;;
		
		112)
			bishbosh_connection_read_PUBCOMP
		;;
		
		130)
			# Only valid for servers
			bishbosh_connection_read_SUBSCRIBE
		;;
		
		144)
			# Only valid for clients
			bishbosh_connection_read_SUBACK
		;;
		
		162)
			# Only valid for servers
			bishbosh_connection_read_UNSUBSCRIBE
		;;
		
		176)
			# Only valid for clients
			bishbosh_connection_read_UNSUBACK
		;;
		
		192)
			# Only valid for servers
			bishbosh_connection_read_PINGREQ
		;;
		
		208)
			# Only valid for clients
			bishbosh_connection_read_PINGRESP
		;;
		
		224)
			# Only valid for servers
			bishbosh_connection_read_DISCONNECT
		;;
		
		*)
			bishbosh_connection_read_invalid
		;;
	esac
}
