core_usesIn bishbosh/connection write

# GNU stat
core_dependency_requires '*' stat
_bishbosh_connection_write_PUBLISH_validateArguments()
{	
	if core_variable_isUnset bishbosh_connection_write_PUBLISH_qos; then
		packetIdentifier=-1
	else
		qos="$bishbosh_connection_write_PUBLISH_qos"
		case "$qos" in
			
			0)
				packetIdentifier=-1	
			;;
			
			1|2)
				if core_variable_isUnset bishbosh_connection_write_PUBLISH_packetIdentifier; then
					core_exitError $core_commandLine_exitCode_CONFIG "The argument 'bishbosh_connection_write_CONNECT_packetIdentifer' must be set when 'bishbosh_connection_write_CONNECT_qos' is '$qos'"
				fi
				bishbosh_connection_write_packetIdentifierCheck bishbosh_connection_write_PUBLISH_packetIdentifier "$bishbosh_connection_write_PUBLISH_packetIdentifer"
				
				controlPacketTypeAndFlags=$(( controlPacketTypeAndFlags + qos << 2 ))
				remainingLength=$(( remainingLength + 2 ))
			;;
			
			*)
				core_exitError $core_commandLine_exitCode_CONFIG "The argument 'bishbosh_connection_write_CONNECT_qos' can not be '$qos', but a value between 0 to 2 inclusive"
			;;
			
		esac
	fi

	if core_variable_isSet bishbosh_connection_write_PUBLISH_retain; then
		if core_variable_isTrue bishbosh_connection_write_PUBLISH_retain; then
			controlPacketTypeAndFlags=$(( controlPacketTypeAndFlags + 1 ))
		fi
	fi
	
	if core_variable_isUnset bishbosh_connection_write_PUBLISH_topicName; then
		core_exitError $core_commandLine_exitCode_CONFIG "The argument 'bishbosh_connection_write_PUBLISH_topicName' must be specified"
	fi
	topicName="$bishbosh_connection_write_PUBLISH_topicName"
	bishbosh_connection_write_validateTopicName bishbosh_connection_write_PUBLISH_topicName "$topicName"
	
	topicName_fieldLength=${#topicName}
	remainingLength=$(( remainingLength + 2 + topicName_fieldLength ))
	
	if core_variable_isUnset bishbosh_connection_write_PUBLISH_message; then
		if core_variable_isUnset bishbosh_connection_write_PUBLISH_messageFilePath; then
			message=''
			message_fieldLength=0
			messageFilePath=''
		else
			message=''
			core_validate_filePathReadable $core_commandLine_exitCode_CONFIG 'argument' bishbosh_connection_write_PUBLISH_messageFilePath "$bishbosh_connection_write_PUBLISH_messageFilePath"
			messageFilePath="$bishbosh_connection_write_PUBLISH_messageFilePath"
			message_fieldLength=$(bishbosh_filesize_${bishbosh_filesizeAlgorithm} "$messageFilePath")
		fi
	else
		if core_variable_isSet bishbosh_connection_write_PUBLISH_messageFilePath; then
			core_exitError $core_commandLine_exitCode_CONFIG "The arguments 'bishbosh_connection_write_PUBLISH_message' and 'bishbosh_connection_write_PUBLISH_message' can not both be specified"
		fi
		message="$bishbosh_connection_write_PUBLISH_message"
		message_fieldLength=${#message}
		messageFilePath=''
		bishbosh_connection_write_fieldLengthCheck PUBLISH message
	fi
	remainingLength=$(( remainingLength + message_fieldLength ))
	
	if core_variable_isSet bishbosh_connection_write_PUBLISH_messageUnlinkFile; then
		if core_variable_isUnset bishbosh_connection_write_PUBLISH_messageFilePath; then
			core_exitError $core_commandLine_exitCode_CONFIG "The argument 'bishbosh_connection_write_PUBLISH_messageUnlinkFile' can not be specified if 'bishbosh_connection_write_PUBLISH_messageFilePath' is not"
		fi
		if core_variable_isTrue bishbosh_connection_write_PUBLISH_messageUnlinkFile; then
			messageUnlinkFile=1
		else
			messageUnlinkFile=0
		fi
	else
		messageUnlinkFile=0
	fi
	
	if core_variable_isSet bishbosh_connection_write_PUBLISH_resetArguments; then
		if core_variable_isTrue bishbosh_connection_write_PUBLISH_resetArguments; then
			resetArguments=1
		else
			resetArguments=0
		fi
	else
		resetArguments=1
	fi
}

_bishbosh_connection_write_PUBLISH_resetArguments()
{
	unset bishbosh_connection_write_PUBLISH_dup
	unset bishbosh_connection_write_PUBLISH_qos
	unset bishbosh_connection_write_PUBLISH_packetIdentifier
	unset bishbosh_connection_write_PUBLISH_retain
	unset bishbosh_connection_write_PUBLISH_topicName
	unset bishbosh_connection_write_PUBLISH_message
	unset bishbosh_connection_write_PUBLISH_messageFilePath
	unset bishbosh_connection_write_PUBLISH_messageUnlinkFile
}

core_dependency_requires '*' cat rm
bishbosh_connection_write_PUBLISH()
{
	local remainingLength=0
	
	# 3 << 4
	local controlPacketTypeAndFlags=48
	local packetIdentifier
	local qos
	local topicName
	local topicName_fieldLength
	local message
	local messageFilePath
	local message_fieldLength
	local messageUnlinkFile
	local resetArguments
	_bishbosh_connection_write_PUBLISH_validateArguments
	
	case $qos in
		
		1)
			local pendingSendQos1PacketIdentifierPath="$bishbosh_connection_sessionPublicationsQos1PendingSendPath"/"$packetIdentifier"
			if [ -f "$pendingSendQos1PacketIdentifierPath" ]; then
				# Set DUP flag
				controlPacketTypeAndFlags=$(( controlPacketTypeAndFlags + 1 << 3 ))
			fi
		;;
		
		2)
			local pendingSendQos2PacketIdentifierPath="$bishbosh_connection_sessionPublicationsQos2PendingSendPath"/"$packetIdentifier"
			local pendingCompQos2PacketIdentifierPath="$bishbosh_connection_sessionPublicationsQos2PendingCompPath"/"$packetIdentifier"
			if [ -f "$pendingCompQos2PacketIdentifierPath" ]; then
				core_exitError $core_commandLine_exitCode_CONFIG "We can not PUBLISH packetIdentifier '$packetIdentifier' because it is pending a PUBCOMP"
			fi
			if [ -f "$pendingSendQos2PacketIdentifierPath" ]; then
				# Set DUP flag
				controlPacketTypeAndFlags=$(( controlPacketTypeAndFlags + 1 << 3 ))
			fi
		;;
		
	esac
	
	bishbosh_connection_write_byte "$controlPacketTypeAndFlags"
	bishbosh_connection_write_remainingLength $remainingLength
	
	bishbosh_connection_write_twoByteLength $topicName_fieldLength
	printf '%s' "$topicName"
	
	if [ $packetIdentifier -ne -1 ]; then
		bishbosh_connection_write_twoByteLength $packetIdentifier
	fi
	
	if [ -z "$messageFilePath" ]; then
		printf '%s' "$message"
	else
		cat "$messageFilePath"
		core_TODO 'Experiment with dd bs=$message_fieldLength count=$message_fieldLength if="$messageFilePath" as an alternative to cat'
	fi
	
	bishbosh_connection_ping_recordLastSentControlPacketAt
	
	case $qos in
		
		1)
			touch "$pendingSendQos1PacketIdentifierPath"
		;;
		
		2)
			touch "$pendingSendQos2PacketIdentifierPath"
		;;
		
	esac
	
	if [ $messageUnlinkFile -eq 1 ]; then
		rm -f $messageUnlinkFile || core_exitError $core_commandLine_exitCode_IOERR "Can not unlink message file '$messageUnlinkFile'."
	fi
	
	if [ $resetArguments -eq 1 ]; then
		_bishbosh_connection_write_PUBLISH_resetArguments
	fi
}
