core_usesIn bishbosh/connection/read controlpacket byte

# https://stackoverflow.com/questions/4874993/bash-script-with-non-blocking-read !!
bishbosh_connection_read_nonBlockingFeatureTest()
{
	local testFifoPath="$(bishbosh_connection_mkfifo 'non-blocking-read-feature-test')"
	exec 5<>"$testFifoPath"
	printf '%s\n' 'test' >&5
	
	local testVariable=''
	set +e
	read -r -u 5 -t $bishbosh_readLatency_inFractionalSeconds testVariable 2>/dev/null
	set -e
	exec 5>&-
	exec 5<&-

	if [ -z "$testVariable" ]; then
		bishbosh_connection_supportsNonBlockingRead=0
		bishbosh_connection_exitCodeForReadTimeout=-1
		return 0
	else
		bishbosh_connection_supportsNonBlockingRead=1
	fi

	local timeoutExitCodeFifoPath="$(bishbosh_connection_mkfifo 'non-blocking-read-timeout-exit-code-feature-test')"
	exec 5<>"$testFifoPath"
	local exitCodeForTimeout
	set +e
	read -r -u 5 -t $bishbosh_readLatency_inFractionalSeconds testVariable 
	bishbosh_connection_exitCodeForReadTimeout=$?
	exec 5>&-
	exec 5<&-
	set -e
}

core_dependency_requires '*' grep
bishbosh_connection_read_initialise()
{
	local isServer="$1"
	
	bishbosh_connection_read_controlpacket_initialise "$isServer"
	bishbosh_connection_read_nonBlockingFeatureTest
	bishbosh_connection_read_byte_initialise
}

bishbosh_connection_read_packetIdentifier()
{
	local packetIdentifierMsb
	local packetIdentifierLsb
	bishbosh_connection_read_byte_blocking packetIdentifierMsb
	bishbosh_connection_read_byte_blocking packetIdentifierLsb
	
	packetIdentifier=$((packetIdentifierMsb * 256 + packetIdentifierLsb))
	
	# We should now 'free' the packet identifier...
}

bishbosh_connection_read_length()
{
	local lengthMsb
	local lengthLsb
	bishbosh_connection_read_byte_blocking lengthMsb
	bishbosh_connection_read_byte_blocking lengthLsb
	
	length=$((lengthMsb * 256 + lengthLsb))
}
