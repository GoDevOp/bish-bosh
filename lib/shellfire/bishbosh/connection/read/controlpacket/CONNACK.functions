core_usesIn bishbosh/connection error

bishbosh_connection_read_controlpacket_CONNACK()
{
	bishbosh_connection_error_ifRemainingLengthNot CONNACK 2
	
	local connectAcknowledgeFlags
	bishbosh_connection_read_byte_blocking connectAcknowledgeFlags
	
	case $connectAcknowledgeFlags in
		
		0)
			bishbosh_connection_sessionPresent=0
		;;
		
		1)
			bishbosh_connection_sessionPresent=1
		;;
		
		*)
			bishbosh_connection_error_protocolReadControlPacket CONNACK "Field 'connectAcknowledgeFlags' was '$connectAcknowledgeFlags', not a value between 0 to 1 inclusive"
		;;
		
	esac
	
	local connectReturnCode
	bishbosh_connection_read_byte_blocking connectReturnCode
	
	case $connectReturnCode in
		
		0)
			# OK
			:
		;;
		
		1)
			bishbosh_connection_error_connectReturnCode $core_commandLine_exitCode_UNAVAILABLE 'Connection Refused, unacceptable protocol version'
		;;
		
		2)
			bishbosh_connection_error_connectReturnCode $core_commandLine_exitCode_NOUSER 'Connection Refused, identifier rejected'
		;;
		
		3)
			bishbosh_connection_error_connectReturnCode $core_commandLine_exitCode_UNAVAILABLE 'Connection Refused, Server unavailable'
		;;
		
		4)
			bishbosh_connection_error_connectReturnCode $core_commandLine_exitCode_NOPERM 'Connection Refused, bad user name or password'
		;;
		
		5)
			bishbosh_connection_error_connectReturnCode $core_commandLine_exitCode_NOPERM 'Connection Refused,  not authorized'
		;;
		
		*)
			bishbosh_connection_error_protocolReadControlPacket CONNACK "Received reserved connectReturnCode code of $connectReturnCode"
		;;
		
	esac
	
	bishbosh_connection_handler_CONNACK
	
	bishbosh_connection_read_controlpacket_CONNACK_republish
	bishbosh_connection_read_controlpacket_CONNACK_repubcomp
}

bishbosh_connection_read_controlpacket_CONNACK_republish()
{
	pushd "$bishbosh_connection_sessionPublicationsPath"
		
		local QoS
		local packetIdentifier
		local extension=.message
		
		local alreadySentMessageMessage
		local alreadySentMessage
		
		for QoS in 1 2
		do
			pushd $QoS
	
				set +f
				for alreadySentMessageMessage in *.${extension}
				do
					set -f
					if [ ! -e "$alreadySentMessageMessage" ]; then
						continue
					fi
					packetIdentifier="$(core_variable_allButLastN "$alreadySentMessageMessage" ${#extension})"
					
					if [ -f "$packetIdentifier".pubrec-received ]; then
						bishbosh_connection_write_packetIdentifier=$packetIdentifier
						bishbosh_connection_write_rePUBREC
					else
						bishbosh_connection_write_rePUBLISH
					fi
				done
				set -f
			popd
		done
	popd
}

bishbosh_connection_read_controlpacket_CONNACK_repubcomp()
{
	pushd "$bishbosh_connection_sessionReceivePath"/2
		
		local sentPubrecRecord
		local extension=.sent-pubrec
		
		set +f
		for sentPubrecRecord in *.${extension}
		do
			set -f
			if [ ! -e "$sentPubrecRecord" ]; then
				continue
			fi
			
			bishbosh_connection_write_packetIdentifier="$(core_variable_allButLastN "$sentPubrecRecord" ${#extension})"
			bishbosh_connection_write_PUBCOMP
		done
		set +f
	
	popd
}
